<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1">

<meta name="author" content="Yann Abraham" />

<meta name="date" content="2019-11-11" />

<title>Identifying Treatment effects using hilbertSimilarity</title>



<style type="text/css">code{white-space: pre;}</style>
<style type="text/css" data-origin="pandoc">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    for (var j = 0; j < rules.length; j++) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") continue;
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') continue;
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>



<link href="data:text/css;charset=utf-8,body%20%7B%0Abackground%2Dcolor%3A%20%23fff%3B%0Amargin%3A%201em%20auto%3B%0Amax%2Dwidth%3A%20700px%3B%0Aoverflow%3A%20visible%3B%0Apadding%2Dleft%3A%202em%3B%0Apadding%2Dright%3A%202em%3B%0Afont%2Dfamily%3A%20%22Open%20Sans%22%2C%20%22Helvetica%20Neue%22%2C%20Helvetica%2C%20Arial%2C%20sans%2Dserif%3B%0Afont%2Dsize%3A%2014px%3B%0Aline%2Dheight%3A%201%2E35%3B%0A%7D%0A%23header%20%7B%0Atext%2Dalign%3A%20center%3B%0A%7D%0A%23TOC%20%7B%0Aclear%3A%20both%3B%0Amargin%3A%200%200%2010px%2010px%3B%0Apadding%3A%204px%3B%0Awidth%3A%20400px%3B%0Aborder%3A%201px%20solid%20%23CCCCCC%3B%0Aborder%2Dradius%3A%205px%3B%0Abackground%2Dcolor%3A%20%23f6f6f6%3B%0Afont%2Dsize%3A%2013px%3B%0Aline%2Dheight%3A%201%2E3%3B%0A%7D%0A%23TOC%20%2Etoctitle%20%7B%0Afont%2Dweight%3A%20bold%3B%0Afont%2Dsize%3A%2015px%3B%0Amargin%2Dleft%3A%205px%3B%0A%7D%0A%23TOC%20ul%20%7B%0Apadding%2Dleft%3A%2040px%3B%0Amargin%2Dleft%3A%20%2D1%2E5em%3B%0Amargin%2Dtop%3A%205px%3B%0Amargin%2Dbottom%3A%205px%3B%0A%7D%0A%23TOC%20ul%20ul%20%7B%0Amargin%2Dleft%3A%20%2D2em%3B%0A%7D%0A%23TOC%20li%20%7B%0Aline%2Dheight%3A%2016px%3B%0A%7D%0Atable%20%7B%0Amargin%3A%201em%20auto%3B%0Aborder%2Dwidth%3A%201px%3B%0Aborder%2Dcolor%3A%20%23DDDDDD%3B%0Aborder%2Dstyle%3A%20outset%3B%0Aborder%2Dcollapse%3A%20collapse%3B%0A%7D%0Atable%20th%20%7B%0Aborder%2Dwidth%3A%202px%3B%0Apadding%3A%205px%3B%0Aborder%2Dstyle%3A%20inset%3B%0A%7D%0Atable%20td%20%7B%0Aborder%2Dwidth%3A%201px%3B%0Aborder%2Dstyle%3A%20inset%3B%0Aline%2Dheight%3A%2018px%3B%0Apadding%3A%205px%205px%3B%0A%7D%0Atable%2C%20table%20th%2C%20table%20td%20%7B%0Aborder%2Dleft%2Dstyle%3A%20none%3B%0Aborder%2Dright%2Dstyle%3A%20none%3B%0A%7D%0Atable%20thead%2C%20table%20tr%2Eeven%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0A%7D%0Ap%20%7B%0Amargin%3A%200%2E5em%200%3B%0A%7D%0Ablockquote%20%7B%0Abackground%2Dcolor%3A%20%23f6f6f6%3B%0Apadding%3A%200%2E25em%200%2E75em%3B%0A%7D%0Ahr%20%7B%0Aborder%2Dstyle%3A%20solid%3B%0Aborder%3A%20none%3B%0Aborder%2Dtop%3A%201px%20solid%20%23777%3B%0Amargin%3A%2028px%200%3B%0A%7D%0Adl%20%7B%0Amargin%2Dleft%3A%200%3B%0A%7D%0Adl%20dd%20%7B%0Amargin%2Dbottom%3A%2013px%3B%0Amargin%2Dleft%3A%2013px%3B%0A%7D%0Adl%20dt%20%7B%0Afont%2Dweight%3A%20bold%3B%0A%7D%0Aul%20%7B%0Amargin%2Dtop%3A%200%3B%0A%7D%0Aul%20li%20%7B%0Alist%2Dstyle%3A%20circle%20outside%3B%0A%7D%0Aul%20ul%20%7B%0Amargin%2Dbottom%3A%200%3B%0A%7D%0Apre%2C%20code%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0Aborder%2Dradius%3A%203px%3B%0Acolor%3A%20%23333%3B%0Awhite%2Dspace%3A%20pre%2Dwrap%3B%20%0A%7D%0Apre%20%7B%0Aborder%2Dradius%3A%203px%3B%0Amargin%3A%205px%200px%2010px%200px%3B%0Apadding%3A%2010px%3B%0A%7D%0Apre%3Anot%28%5Bclass%5D%29%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0A%7D%0Acode%20%7B%0Afont%2Dfamily%3A%20Consolas%2C%20Monaco%2C%20%27Courier%20New%27%2C%20monospace%3B%0Afont%2Dsize%3A%2085%25%3B%0A%7D%0Ap%20%3E%20code%2C%20li%20%3E%20code%20%7B%0Apadding%3A%202px%200px%3B%0A%7D%0Adiv%2Efigure%20%7B%0Atext%2Dalign%3A%20center%3B%0A%7D%0Aimg%20%7B%0Abackground%2Dcolor%3A%20%23FFFFFF%3B%0Apadding%3A%202px%3B%0Aborder%3A%201px%20solid%20%23DDDDDD%3B%0Aborder%2Dradius%3A%203px%3B%0Aborder%3A%201px%20solid%20%23CCCCCC%3B%0Amargin%3A%200%205px%3B%0A%7D%0Ah1%20%7B%0Amargin%2Dtop%3A%200%3B%0Afont%2Dsize%3A%2035px%3B%0Aline%2Dheight%3A%2040px%3B%0A%7D%0Ah2%20%7B%0Aborder%2Dbottom%3A%204px%20solid%20%23f7f7f7%3B%0Apadding%2Dtop%3A%2010px%3B%0Apadding%2Dbottom%3A%202px%3B%0Afont%2Dsize%3A%20145%25%3B%0A%7D%0Ah3%20%7B%0Aborder%2Dbottom%3A%202px%20solid%20%23f7f7f7%3B%0Apadding%2Dtop%3A%2010px%3B%0Afont%2Dsize%3A%20120%25%3B%0A%7D%0Ah4%20%7B%0Aborder%2Dbottom%3A%201px%20solid%20%23f7f7f7%3B%0Amargin%2Dleft%3A%208px%3B%0Afont%2Dsize%3A%20105%25%3B%0A%7D%0Ah5%2C%20h6%20%7B%0Aborder%2Dbottom%3A%201px%20solid%20%23ccc%3B%0Afont%2Dsize%3A%20105%25%3B%0A%7D%0Aa%20%7B%0Acolor%3A%20%230033dd%3B%0Atext%2Ddecoration%3A%20none%3B%0A%7D%0Aa%3Ahover%20%7B%0Acolor%3A%20%236666ff%3B%20%7D%0Aa%3Avisited%20%7B%0Acolor%3A%20%23800080%3B%20%7D%0Aa%3Avisited%3Ahover%20%7B%0Acolor%3A%20%23BB00BB%3B%20%7D%0Aa%5Bhref%5E%3D%22http%3A%22%5D%20%7B%0Atext%2Ddecoration%3A%20underline%3B%20%7D%0Aa%5Bhref%5E%3D%22https%3A%22%5D%20%7B%0Atext%2Ddecoration%3A%20underline%3B%20%7D%0A%0Acode%20%3E%20span%2Ekw%20%7B%20color%3A%20%23555%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%0Acode%20%3E%20span%2Edt%20%7B%20color%3A%20%23902000%3B%20%7D%20%0Acode%20%3E%20span%2Edv%20%7B%20color%3A%20%2340a070%3B%20%7D%20%0Acode%20%3E%20span%2Ebn%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Efl%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Ech%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Est%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Eco%20%7B%20color%3A%20%23888888%3B%20font%2Dstyle%3A%20italic%3B%20%7D%20%0Acode%20%3E%20span%2Eot%20%7B%20color%3A%20%23007020%3B%20%7D%20%0Acode%20%3E%20span%2Eal%20%7B%20color%3A%20%23ff0000%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%0Acode%20%3E%20span%2Efu%20%7B%20color%3A%20%23900%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%20code%20%3E%20span%2Eer%20%7B%20color%3A%20%23a61717%3B%20background%2Dcolor%3A%20%23e3d2d2%3B%20%7D%20%0A" rel="stylesheet" type="text/css" />




</head>

<body>




<h1 class="title toc-ignore">Identifying Treatment effects using hilbertSimilarity</h1>
<h4 class="author">Yann Abraham</h4>
<h4 class="date">2019-11-11</h4>



<div id="introduction" class="section level1">
<h1>Introduction</h1>
<p>Comparing samples defined over a single dimension is a straightforward task that relies on standard, well established methods. Meanwhile distance between samples in high dimensional space remains a largely unexplored field. Available solutions rely on multivariate normal distributions, a condition that is both difficult to check and overlooking key behaviors in biological samples, where populations of interest often correspond to a small proportion (&lt;1%) of all the points that have been measured.</p>
<p>We have developed <code>hilbertSimilarity</code> to address the problem of sample similarity in mass cytometry where samples are measured over up to 100 dimensions, and where each sample contains a slightly different number of points (or cells). Our method first transforms each sample into a probability vector, by dividing each dimension into a fixed number of bins and by associating each cell to a specific multidimensional cube. The proportion of cells in each hypercube is characteristic of a given sample. To characterize an compare samples we use measures from Information Theory, since their interpretation in terms of similarity and complexity is straightforward.</p>
<p>After determining sample similarity, our method can also be used to determine which cells are different between samples, by comparing the number of cells in each hypercube to a reference treatment. Since every sample contains a different number of cells, we use a bootstrap approach where the same number of cells is sampled from each treatment to allow for a direct comparison.</p>
<p>To demonstrate the power of <code>hilbertSimilarity</code> we applied the method to a subset of the bodenmiller <em>et al.</em> dataset, comparing the effect of different stimulations and identifying groups of cells that are significantly affected by different treatments.</p>
<p>Compared to other methods, <code>hilbertSimilarity</code> does not rely on expert-driven gating, or require any hypothesis about the number of populations that are present in the data. This makes it a powerful tool to quickly assess a dataset before using traditional methods, or when populations a not known <em>a priori</em>.</p>
</div>
<div id="installation" class="section level1">
<h1>Installation</h1>
<p><code>hilbertSimilarity</code> can be installed using the following command</p>
<pre><code>devtools::install_github(yannabraham/hilbertSimilarity)</code></pre>
<p>Once installed the package can be loaded using the standard <code>library</code> command.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(hilbertSimilarity)</code></pre></div>
</div>
<div id="loading-some-test-data" class="section level1">
<h1>Loading some test data</h1>
<p>We first need data from the <code>bodenmiller</code> package:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(bodenmiller)
<span class="kw">data</span>(refPhenoMat)
<span class="kw">data</span>(untreatedPhenoMat)
<span class="kw">data</span>(refFuncMat)
<span class="kw">data</span>(untreatedFuncMat)
<span class="kw">data</span>(refAnnots)
refAnnots<span class="op">$</span>Treatment &lt;-<span class="st"> 'reference'</span>
<span class="kw">data</span>(untreatedAnnots)
fullAnnots &lt;-<span class="st"> </span><span class="kw">rbind</span>(refAnnots[,<span class="kw">names</span>(untreatedAnnots)],
                    untreatedAnnots)
fullAnnots<span class="op">$</span>Treatment &lt;-<span class="st"> </span><span class="kw">factor</span>(fullAnnots<span class="op">$</span>Treatment)
fullAnnots<span class="op">$</span>Treatment &lt;-<span class="st"> </span><span class="kw">relevel</span>(fullAnnots<span class="op">$</span>Treatment,<span class="st">'reference'</span>)
refMat &lt;-<span class="st"> </span><span class="kw">cbind</span>(refPhenoMat,refFuncMat)
untreatedMat &lt;-<span class="st"> </span><span class="kw">cbind</span>(untreatedPhenoMat,
                      untreatedFuncMat)
fullMat &lt;-<span class="st"> </span><span class="kw">rbind</span>(refMat,untreatedMat)
fullMat &lt;-<span class="st"> </span><span class="kw">apply</span>(fullMat,<span class="dv">2</span>,<span class="cf">function</span>(x) {
    x[x<span class="op">&lt;</span><span class="dv">0</span>] &lt;-<span class="st"> </span><span class="dv">0</span>
    <span class="kw">return</span>(x)
  }
)</code></pre></div>
<p>In this dataset 51936 cells corresponding to 4 have been measured over 23 channels. Cells have been gated into 14 populations. The following treatments are compared to one another:</p>
<table>
<thead>
<tr class="header">
<th></th>
<th align="right">reference</th>
<th align="right">BCR/FcR-XL</th>
<th align="right">PMA/Ionomycin</th>
<th align="right">vanadate</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>cd14-hladr-</td>
<td align="right">22</td>
<td align="right">18</td>
<td align="right">25</td>
<td align="right">27</td>
</tr>
<tr class="even">
<td>cd14-hladrhigh</td>
<td align="right">60</td>
<td align="right">19</td>
<td align="right">4</td>
<td align="right">1</td>
</tr>
<tr class="odd">
<td>cd14-hladrmid</td>
<td align="right">244</td>
<td align="right">149</td>
<td align="right">54</td>
<td align="right">18</td>
</tr>
<tr class="even">
<td>cd14-surf-</td>
<td align="right">1807</td>
<td align="right">1845</td>
<td align="right">1520</td>
<td align="right">1824</td>
</tr>
<tr class="odd">
<td>cd14+hladr-</td>
<td align="right">13</td>
<td align="right">17</td>
<td align="right">15</td>
<td align="right">91</td>
</tr>
<tr class="even">
<td>cd14+hladrhigh</td>
<td align="right">21</td>
<td align="right">3</td>
<td align="right">5</td>
<td align="right">1</td>
</tr>
<tr class="odd">
<td>cd14+hladrmid</td>
<td align="right">1373</td>
<td align="right">839</td>
<td align="right">298</td>
<td align="right">155</td>
</tr>
<tr class="even">
<td>cd14+surf-</td>
<td align="right">81</td>
<td align="right">77</td>
<td align="right">214</td>
<td align="right">166</td>
</tr>
<tr class="odd">
<td>cd4+</td>
<td align="right">3989</td>
<td align="right">4076</td>
<td align="right">4546</td>
<td align="right">503</td>
</tr>
<tr class="even">
<td>cd8+</td>
<td align="right">5068</td>
<td align="right">5098</td>
<td align="right">5122</td>
<td align="right">1200</td>
</tr>
<tr class="odd">
<td>dendritic</td>
<td align="right">58</td>
<td align="right">30</td>
<td align="right">28</td>
<td align="right">23</td>
</tr>
<tr class="even">
<td>igm-</td>
<td align="right">232</td>
<td align="right">330</td>
<td align="right">181</td>
<td align="right">90</td>
</tr>
<tr class="odd">
<td>igm+</td>
<td align="right">1069</td>
<td align="right">863</td>
<td align="right">992</td>
<td align="right">395</td>
</tr>
<tr class="even">
<td>nk</td>
<td align="right">1755</td>
<td align="right">1888</td>
<td align="right">1572</td>
<td align="right">1822</td>
</tr>
</tbody>
</table>
<p>The smallest cell population, cd14+hladrhigh, corresponds to 0.058% of the total cells.</p>
</div>
<div id="computing-the-similarity-between-treatments" class="section level1">
<h1>Computing the similarity between treatments</h1>
<p>We will first compute the similarity between treatments, by generating a 3<sup>rd</sup>-order Hilbert curve using combined cuts:</p>
<ul>
<li>computing the cuts</li>
</ul>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># compute the </span>
nbins &lt;-<span class="st"> </span><span class="dv">3</span>
cuts &lt;-<span class="st"> </span><span class="kw">make.cut</span>(fullMat,
                 <span class="dt">n=</span>nbins<span class="op">+</span><span class="dv">1</span>,
                 <span class="dt">count.lim=</span><span class="dv">40</span>)</code></pre></div>
<pre><code>## CD20 
## IgM 
## CD4 
## CD33 
## HLA.DR 
## CD14 
## CD7 
## CD3 
## CD123 
## pStat1 
## pSlp76 
## pBtk 
## pPlcg2 
## pErk 
## pLat 
## pS6 
## pNFkB 
## pp38 
## pStat5 
## pAkt 
## pSHP2 
## pZap70 
## pStat3</code></pre>
<ul>
<li>cutting the matrix</li>
</ul>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">cutFullMat &lt;-<span class="st"> </span><span class="kw">do.cut</span>(fullMat,cuts,<span class="dt">type=</span><span class="st">'combined'</span>)</code></pre></div>
<ul>
<li>ordering the dimensions</li>
</ul>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(entropy)
miFullMat &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="ot">NA</span>,<span class="dt">nrow=</span><span class="kw">ncol</span>(fullMat),<span class="dt">ncol =</span> <span class="kw">ncol</span>(fullMat) )
<span class="cf">for</span> (i <span class="cf">in</span> <span class="kw">seq</span>(<span class="kw">ncol</span>(fullMat)<span class="op">-</span><span class="dv">1</span>)) {
  <span class="cf">for</span> (j <span class="cf">in</span> <span class="kw">seq</span>(i<span class="op">+</span><span class="dv">1</span>,<span class="kw">ncol</span>(fullMat))) {
    cur.tbl &lt;-<span class="st"> </span><span class="kw">table</span>(cutFullMat[,i],cutFullMat[,j])
    nent &lt;-<span class="st"> </span><span class="dv">1</span><span class="op">-</span><span class="kw">mi.empirical</span>(cur.tbl)<span class="op">/</span><span class="kw">entropy.empirical</span>(cur.tbl)
    miFullMat[i,j] &lt;-<span class="st"> </span>miFullMat[j,i] &lt;-<span class="st"> </span>nent
  }
}
<span class="kw">dimnames</span>(miFullMat) &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="kw">colnames</span>(fullMat),<span class="kw">colnames</span>(fullMat))
hcFullMat &lt;-<span class="st"> </span><span class="kw">hclust</span>(<span class="kw">as.dist</span>(miFullMat))</code></pre></div>
<ul>
<li>generating the Hilbert curve</li>
</ul>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">hc &lt;-<span class="st"> </span><span class="kw">do.hilbert</span>(cutFullMat[,<span class="kw">rev</span>(hcFullMat<span class="op">$</span>order)],<span class="dv">2</span>)</code></pre></div>
<ul>
<li>Visualizing the different samples</li>
</ul>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(reshape2)
<span class="kw">library</span>(dplyr)
<span class="kw">library</span>(ggplot2)
treatment.table &lt;-<span class="st"> </span><span class="kw">with</span>(fullAnnots,
                        <span class="kw">table</span>(hc,Treatment))
treatment.pc &lt;-<span class="st"> </span><span class="kw">apply</span>(treatment.table,<span class="dv">2</span>,<span class="cf">function</span>(x) x<span class="op">/</span><span class="kw">sum</span>(x))
av &lt;-<span class="st"> </span><span class="kw">andrewsProjection</span>(<span class="kw">t</span>(treatment.pc),<span class="dt">breaks=</span><span class="dv">40</span>)
treatment.proj &lt;-<span class="st"> </span><span class="kw">t</span>(treatment.pc) <span class="op">%*%</span><span class="st"> </span><span class="kw">t</span>(av<span class="op">$</span>freq)
<span class="kw">melt</span>(treatment.proj) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">rename</span>(<span class="dt">AndrewsIndex=</span>Var2) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">mutate</span>(<span class="dt">AndrewsIndex=</span>av<span class="op">$</span>i[AndrewsIndex]) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x=</span>AndrewsIndex,<span class="dt">y=</span>value))<span class="op">+</span>
<span class="st">    </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">group=</span>Treatment,<span class="dt">color=</span>Treatment))<span class="op">+</span>
<span class="st">    </span><span class="kw">theme_light</span>(<span class="dt">base_size=</span><span class="dv">16</span>)<span class="op">+</span>
<span class="st">    </span><span class="kw">theme</span>(<span class="dt">axis.title.x=</span><span class="kw">element_blank</span>(),
          <span class="dt">axis.text.x=</span><span class="kw">element_blank</span>(),
          <span class="dt">axis.ticks.x=</span><span class="kw">element_blank</span>(),
          <span class="dt">axis.title.y=</span><span class="kw">element_blank</span>(),
          <span class="dt">axis.text.y=</span><span class="kw">element_blank</span>(),
          <span class="dt">axis.ticks.y=</span><span class="kw">element_blank</span>())</code></pre></div>
<p><img src="data:image/png;base64,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" style="display: block; margin: auto;" /></p>
</div>
<div id="identifying-treatment-effects" class="section level1">
<h1>Identifying treatment effects</h1>
<p>For the comparison to be meaningful, we need to limit the analysis to bins that contain a minimum number of cells. This number is arbitrary, and represents the smallest group of cells that should be called a population. We also need to define the number of bootstrap, the significant fold change, and the limit of significance:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># total cells per Hilbert index per treatment</span>
treatment.table &lt;-<span class="st"> </span><span class="kw">with</span>(fullAnnots,
                        <span class="kw">table</span>(hc,Treatment))
<span class="co"># minimum number of cells</span>
lim &lt;-<span class="st"> </span><span class="dv">40</span>
<span class="co"># number of bootstraps</span>
N &lt;-<span class="st"> </span><span class="dv">400</span>
<span class="co"># significant fold change</span>
flim &lt;-<span class="st"> </span><span class="dv">2</span>
<span class="co"># limit of significance</span>
p &lt;-<span class="st"> </span><span class="fl">0.95</span>
<span class="co"># bins with enough cells</span>
boot.ind &lt;-<span class="st"> </span><span class="kw">rownames</span>(treatment.table)[<span class="kw">which</span>(<span class="kw">rowSums</span>(treatment.table)<span class="op">&gt;=</span>lim)]
<span class="co"># number of cells in each bootstrap</span>
ncells &lt;-<span class="st"> </span><span class="kw">floor</span>(<span class="kw">min</span>(<span class="kw">colSums</span>(treatment.table[boot.ind,]))<span class="op">/</span><span class="dv">1000</span>)<span class="op">*</span><span class="dv">1000</span></code></pre></div>
<p>For this exercise we use 40 as the minimum population size. 218 indices out of 7114 contain enough cells.</p>
<p>Because each treatment corresponds to a different number of cells, we will use a bootstrap approach to identify indices that are significantly different between conditions. we will bootstrap 2000 cells from the selected bins, then check which bin contains at least 2 times more cells in the reference compared to other treatments. This operation will be repeated 400 times, and any bin that is consistently different in 380 bins will be considered significant.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(abind)
boot.mat &lt;-<span class="st"> </span><span class="kw">lapply</span>(<span class="kw">seq</span>(<span class="dv">1</span>,N),<span class="cf">function</span>(x) {
    <span class="cf">if</span> (x<span class="op">%/%</span><span class="dv">100</span><span class="op">==</span>x<span class="op">/</span><span class="dv">100</span>) <span class="kw">cat</span>(x,<span class="st">'</span><span class="ch">\n</span><span class="st">'</span>)
    <span class="co"># bootstrap hilbert indices</span>
    cur.boot &lt;-<span class="st"> </span><span class="kw">sample</span>(<span class="kw">which</span>(hc <span class="op">%in%</span><span class="st"> </span>boot.ind),
                       <span class="dt">size=</span>ncells,
                       <span class="dt">replace=</span><span class="ot">TRUE</span>)
    <span class="kw">return</span>(<span class="kw">table</span>(<span class="kw">factor</span>(hc[cur.boot],<span class="dt">levels=</span>boot.ind),
                 <span class="kw">droplevels</span>(fullAnnots[cur.boot,<span class="st">'Treatment'</span>])))
  }
)</code></pre></div>
<pre><code>## 100 
## 200 
## 300 
## 400</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">boot.mat &lt;-<span class="st"> </span><span class="kw">abind</span>(boot.mat,<span class="dt">along=</span><span class="dv">3</span>)

boot.log &lt;-<span class="st"> </span><span class="kw">log2</span>(boot.mat)
boot.fold &lt;-<span class="st"> </span><span class="kw">sweep</span>(boot.log[,<span class="op">-</span><span class="dv">1</span>,],<span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">3</span>),boot.log[,<span class="dv">1</span>,])
boot.sign &lt;-<span class="st"> </span><span class="kw">sign</span>(boot.fold)
boot.sign[<span class="kw">abs</span>(boot.fold)<span class="op">&lt;</span><span class="kw">log2</span>(flim)] &lt;-<span class="st"> </span><span class="dv">0</span>
boot.res &lt;-<span class="st"> </span><span class="kw">apply</span>(boot.sign,<span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">2</span>),<span class="cf">function</span>(x) <span class="kw">table</span>(<span class="kw">sign</span>(x))[<span class="kw">c</span>(<span class="st">'-1'</span>,<span class="st">'0'</span>,<span class="st">'1'</span>)])
boot.res &lt;-<span class="st"> </span><span class="kw">aperm</span>(boot.res,<span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">1</span>,<span class="dv">3</span>))
boot.res[<span class="kw">is.na</span>(boot.res)] &lt;-<span class="st"> </span><span class="dv">0</span>
<span class="kw">dimnames</span>(boot.res)[[<span class="dv">2</span>]] &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">'-1'</span>,<span class="st">'0'</span>,<span class="st">'1'</span>)</code></pre></div>
<p>After the analysis, the following number of bins are found significant:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">sig.res &lt;-<span class="st"> </span><span class="kw">apply</span>(boot.res[,<span class="kw">c</span>(<span class="st">'-1'</span>,<span class="st">'1'</span>),]<span class="op">&gt;</span>(N<span class="op">*</span>p),<span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">3</span>),any)
sum.sig.res &lt;-<span class="st"> </span><span class="kw">cbind</span>(<span class="kw">colSums</span>(sig.res),
                     <span class="kw">colSums</span>(treatment.table[boot.ind[<span class="kw">rowSums</span>(sig.res)<span class="op">&gt;</span><span class="dv">0</span>],<span class="kw">colnames</span>(sig.res)]))

p.cells.sig.res &lt;-<span class="st"> </span><span class="kw">lapply</span>(<span class="kw">colnames</span>(sig.res),
                          <span class="cf">function</span>(cur.cl) {
                              x &lt;-<span class="st"> </span>treatment.table[boot.ind,cur.cl]
                              <span class="kw">return</span>(<span class="kw">sum</span>(x[sig.res[,cur.cl]])<span class="op">/</span><span class="kw">sum</span>(x))
                            }
                          )
<span class="kw">names</span>(p.cells.sig.res) &lt;-<span class="st"> </span><span class="kw">colnames</span>(sig.res)
sum.sig.res &lt;-<span class="st"> </span><span class="kw">cbind</span>(sum.sig.res,
                     <span class="kw">round</span>(<span class="dv">100</span><span class="op">*</span><span class="kw">unlist</span>(p.cells.sig.res),<span class="dv">0</span>))
<span class="kw">colnames</span>(sum.sig.res) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">'Number of indices'</span>,
                           <span class="st">'Number of Significant cells'</span>,
                           <span class="st">'Percent Significant Cells'</span>)
<span class="kw">kable</span>(sum.sig.res)</code></pre></div>
<table>
<thead>
<tr class="header">
<th></th>
<th align="right">Number of indices</th>
<th align="right">Number of Significant cells</th>
<th align="right">Percent Significant Cells</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>BCR/FcR-XL</td>
<td align="right">3</td>
<td align="right">5788</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td>PMA/Ionomycin</td>
<td align="right">47</td>
<td align="right">4129</td>
<td align="right">46</td>
</tr>
<tr class="odd">
<td>vanadate</td>
<td align="right">45</td>
<td align="right">1733</td>
<td align="right">28</td>
</tr>
</tbody>
</table>
<p>Focusing on <strong>BCR/FcR-XL</strong>, which are the 3 indices that were found significant?</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">kable</span>(treatment.table[boot.ind[sig.res[,<span class="st">'BCR/FcR-XL'</span>]],])</code></pre></div>
<table>
<thead>
<tr class="header">
<th></th>
<th align="right">reference</th>
<th align="right">BCR/FcR-XL</th>
<th align="right">PMA/Ionomycin</th>
<th align="right">vanadate</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>2098176</td>
<td align="right">1</td>
<td align="right">97</td>
<td align="right">32</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td>4194304</td>
<td align="right">69</td>
<td align="right">3</td>
<td align="right">7</td>
<td align="right">13</td>
</tr>
<tr class="odd">
<td>6291455</td>
<td align="right">198</td>
<td align="right">14</td>
<td align="right">23</td>
<td align="right">48</td>
</tr>
</tbody>
</table>
<p>Compared to the unstimulated sample, cells are decreasing in 2 bins and increasing in a 3<sup>rd</sup> one. Based on manual gating, what do these bins correspond to?</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">cur.treatment &lt;-<span class="st"> 'BCR/FcR-XL'</span>
sig.cells &lt;-<span class="st"> </span><span class="kw">with</span>(fullAnnots,<span class="kw">table</span>(<span class="kw">droplevels</span>(Cells[hc <span class="op">%in%</span><span class="st"> </span>boot.ind[sig.res[,cur.treatment]]])))
total.sig.cells &lt;-<span class="st"> </span><span class="kw">with</span>(fullAnnots,<span class="kw">table</span>(<span class="kw">droplevels</span>(Cells[Cells <span class="op">%in%</span><span class="st"> </span><span class="kw">names</span>(sig.cells) <span class="op">&amp;</span>
<span class="st">                                                       </span>hc <span class="op">%in%</span><span class="st"> </span>boot.ind])))
treatment.sig.cells &lt;-<span class="st"> </span><span class="kw">with</span>(fullAnnots,
                            <span class="kw">table</span>(<span class="kw">droplevels</span>(Cells[hc <span class="op">%in%</span><span class="st"> </span>boot.ind[sig.res[,cur.treatment]] <span class="op">&amp;</span>
<span class="st">                                                     </span>Treatment<span class="op">==</span>cur.treatment])))
treatment.total.cells &lt;-<span class="st"> </span><span class="kw">with</span>(fullAnnots,
                              <span class="kw">table</span>(<span class="kw">droplevels</span>(Cells[Cells <span class="op">%in%</span><span class="st"> </span><span class="kw">names</span>(sig.cells) <span class="op">&amp;</span>
<span class="st">                                                       </span>hc <span class="op">%in%</span><span class="st"> </span>boot.ind <span class="op">&amp;</span>
<span class="st">                                                       </span>Treatment<span class="op">==</span>cur.treatment])))
sum.sig.cells &lt;-<span class="st"> </span><span class="kw">cbind</span>(sig.cells,
                       total.sig.cells,
                       <span class="kw">round</span>(<span class="dv">100</span><span class="op">*</span>sig.cells<span class="op">/</span>total.sig.cells),
                       treatment.sig.cells,
                       treatment.total.cells,
                       <span class="kw">round</span>(<span class="dv">100</span><span class="op">*</span>treatment.sig.cells<span class="op">/</span>treatment.total.cells))

<span class="kw">colnames</span>(sum.sig.cells) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">'Number of Significant Cells'</span>,
                             <span class="st">'Total number of Cells'</span>,
                             <span class="st">'Percent of Total'</span>,
                             <span class="kw">paste</span>(<span class="st">'Number of Signigicant Cells in'</span>,cur.treatment),
                             <span class="kw">paste</span>(<span class="st">'Number of Cells in'</span>,cur.treatment),
                             <span class="kw">paste</span>(<span class="st">'Percent of'</span>,cur.treatment))
<span class="kw">kable</span>(sum.sig.cells)</code></pre></div>
<table>
<thead>
<tr class="header">
<th></th>
<th align="right">Number of Significant Cells</th>
<th align="right">Total number of Cells</th>
<th align="right">Percent of Total</th>
<th align="right">Number of Signigicant Cells in BCR/FcR-XL</th>
<th align="right">Number of Cells in BCR/FcR-XL</th>
<th align="right">Percent of BCR/FcR-XL</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>igm-</td>
<td align="right">30</td>
<td align="right">288</td>
<td align="right">10</td>
<td align="right">23</td>
<td align="right">119</td>
<td align="right">19</td>
</tr>
<tr class="even">
<td>igm+</td>
<td align="right">475</td>
<td align="right">1373</td>
<td align="right">35</td>
<td align="right">91</td>
<td align="right">320</td>
<td align="right">28</td>
</tr>
</tbody>
</table>
<p>All the cells that are found significant are B cells, and they represent a large fraction of all B cells in the BCR/FcR-XL sample, even when only taking the bootstrapped indices into account.</p>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
