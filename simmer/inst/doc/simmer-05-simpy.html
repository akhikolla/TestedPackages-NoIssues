<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />

<meta name="author" content="Iñaki Ucar" />

<meta name="date" content="2020-06-06" />

<title>Other SimPy Examples</title>



<style type="text/css">code{white-space: pre;}</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    for (var j = 0; j < rules.length; j++) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") continue;
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') continue;
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>



<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; } 
code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">Other SimPy Examples</h1>
<h4 class="author">Iñaki Ucar</h4>
<h4 class="date">2020-06-06</h4>


<div id="TOC">
<ul>
<li><a href="#introduction">Introduction</a></li>
<li><a href="#carwash">Carwash</a></li>
<li><a href="#machine-shop">Machine Shop</a></li>
<li><a href="#movie-renege">Movie Renege</a></li>
<li><a href="#gas-station-refuelling">Gas Station Refuelling</a></li>
</ul>
</div>

<div id="introduction" class="section level2">
<h2>Introduction</h2>
<p>These examples are adapted from the Python package ‘SimPy’, <a href="https://simpy.readthedocs.io/en/latest/examples">here</a>. Users familiar with SimPy may find these examples helpful for transitioning to <code>simmer</code>. Some very basic material is not covered. Beginners should first read <em><a href="simmer-04-bank-1.html">The Bank Tutorial: Part I</a> &amp; <a href="simmer-04-bank-2.html">Part II</a></em>.</p>
</div>
<div id="carwash" class="section level2">
<h2>Carwash</h2>
<p>Covers:</p>
<ul>
<li>Standard resources.</li>
<li>Waiting for other processes.</li>
<li>Logging messages into the console.</li>
</ul>
<p>From <a href="https://simpy.readthedocs.io/en/latest/examples/carwash.html">here</a>:</p>
<blockquote>
<p>A carwash has a limited number of washing machines and defines a washing process that takes some time. Cars arrive at the carwash at a random time. If one washing machine is available, they start the washing process and wait for it to finish. If not, they wait until they an use one.</p>
</blockquote>
<p>Parameters and setup:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a><span class="kw">library</span>(simmer)</span>
<span id="cb1-2"><a href="#cb1-2"></a></span>
<span id="cb1-3"><a href="#cb1-3"></a>NUM_MACHINES &lt;-<span class="st"> </span><span class="dv">2</span>  <span class="co"># Number of machines in the carwash</span></span>
<span id="cb1-4"><a href="#cb1-4"></a>WASHTIME &lt;-<span class="st"> </span><span class="dv">5</span>      <span class="co"># Minutes it takes to clean a car</span></span>
<span id="cb1-5"><a href="#cb1-5"></a>T_INTER &lt;-<span class="st"> </span><span class="dv">7</span>       <span class="co"># Create a car every ~7 minutes</span></span>
<span id="cb1-6"><a href="#cb1-6"></a>SIM_TIME &lt;-<span class="st"> </span><span class="dv">20</span>     <span class="co"># Simulation time in minutes</span></span>
<span id="cb1-7"><a href="#cb1-7"></a></span>
<span id="cb1-8"><a href="#cb1-8"></a><span class="co"># setup</span></span>
<span id="cb1-9"><a href="#cb1-9"></a><span class="kw">set.seed</span>(<span class="dv">42</span>)</span>
<span id="cb1-10"><a href="#cb1-10"></a>env &lt;-<span class="st"> </span><span class="kw">simmer</span>()</span></code></pre></div>
<p>The implementation with <code>simmer</code> is as simple as defining the trajectory each arriving <code>car</code> will share and follow. This trajectory comprises seizing a wash machine, spending some time and releasing it. The process takes <code>WASHTIME</code> and removes some random percentage of dirt between 50 and 90%. The <code>log_()</code> messages are merely illustrative.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1"></a>car &lt;-<span class="st"> </span><span class="kw">trajectory</span>() <span class="op">%&gt;%</span></span>
<span id="cb2-2"><a href="#cb2-2"></a><span class="st">  </span><span class="kw">log_</span>(<span class="st">&quot;arrives at the carwash&quot;</span>) <span class="op">%&gt;%</span></span>
<span id="cb2-3"><a href="#cb2-3"></a><span class="st">  </span><span class="kw">seize</span>(<span class="st">&quot;wash&quot;</span>, <span class="dv">1</span>) <span class="op">%&gt;%</span></span>
<span id="cb2-4"><a href="#cb2-4"></a><span class="st">  </span><span class="kw">log_</span>(<span class="st">&quot;enters the carwash&quot;</span>) <span class="op">%&gt;%</span></span>
<span id="cb2-5"><a href="#cb2-5"></a><span class="st">  </span><span class="kw">timeout</span>(WASHTIME) <span class="op">%&gt;%</span></span>
<span id="cb2-6"><a href="#cb2-6"></a><span class="st">  </span><span class="kw">set_attribute</span>(<span class="st">&quot;dirt_removed&quot;</span>, <span class="cf">function</span>() <span class="kw">sample</span>(<span class="dv">50</span><span class="op">:</span><span class="dv">99</span>, <span class="dv">1</span>)) <span class="op">%&gt;%</span></span>
<span id="cb2-7"><a href="#cb2-7"></a><span class="st">  </span><span class="kw">log_</span>(<span class="cf">function</span>() </span>
<span id="cb2-8"><a href="#cb2-8"></a>    <span class="kw">paste0</span>(<span class="kw">get_attribute</span>(env, <span class="st">&quot;dirt_removed&quot;</span>), <span class="st">&quot;% of dirt was removed&quot;</span>)) <span class="op">%&gt;%</span></span>
<span id="cb2-9"><a href="#cb2-9"></a><span class="st">  </span><span class="kw">release</span>(<span class="st">&quot;wash&quot;</span>, <span class="dv">1</span>) <span class="op">%&gt;%</span></span>
<span id="cb2-10"><a href="#cb2-10"></a><span class="st">  </span><span class="kw">log_</span>(<span class="st">&quot;leaves the carwash&quot;</span>)</span></code></pre></div>
<p>Finally, we setup the resources and feed the trajectory with a couple of generators. The result is shown below:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1"></a>env <span class="op">%&gt;%</span></span>
<span id="cb3-2"><a href="#cb3-2"></a><span class="st">  </span><span class="kw">add_resource</span>(<span class="st">&quot;wash&quot;</span>, NUM_MACHINES) <span class="op">%&gt;%</span></span>
<span id="cb3-3"><a href="#cb3-3"></a><span class="st">  </span><span class="co"># feed the trajectory with 4 initial cars</span></span>
<span id="cb3-4"><a href="#cb3-4"></a><span class="st">  </span><span class="kw">add_generator</span>(<span class="st">&quot;car_initial&quot;</span>, car, <span class="kw">at</span>(<span class="kw">rep</span>(<span class="dv">0</span>, <span class="dv">4</span>))) <span class="op">%&gt;%</span></span>
<span id="cb3-5"><a href="#cb3-5"></a><span class="st">  </span><span class="co"># new cars approx. every T_INTER minutes</span></span>
<span id="cb3-6"><a href="#cb3-6"></a><span class="st">  </span><span class="kw">add_generator</span>(<span class="st">&quot;car&quot;</span>, car, <span class="cf">function</span>() <span class="kw">sample</span>((T_INTER<span class="dv">-2</span>)<span class="op">:</span>(T_INTER<span class="op">+</span><span class="dv">2</span>), <span class="dv">1</span>)) <span class="op">%&gt;%</span></span>
<span id="cb3-7"><a href="#cb3-7"></a><span class="st">  </span><span class="co"># start the simulation</span></span>
<span id="cb3-8"><a href="#cb3-8"></a><span class="st">  </span><span class="kw">run</span>(SIM_TIME)</span>
<span id="cb3-9"><a href="#cb3-9"></a><span class="co">#&gt; 0: car_initial0: arrives at the carwash</span></span>
<span id="cb3-10"><a href="#cb3-10"></a><span class="co">#&gt; 0: car_initial0: enters the carwash</span></span>
<span id="cb3-11"><a href="#cb3-11"></a><span class="co">#&gt; 0: car_initial1: arrives at the carwash</span></span>
<span id="cb3-12"><a href="#cb3-12"></a><span class="co">#&gt; 0: car_initial1: enters the carwash</span></span>
<span id="cb3-13"><a href="#cb3-13"></a><span class="co">#&gt; 0: car_initial2: arrives at the carwash</span></span>
<span id="cb3-14"><a href="#cb3-14"></a><span class="co">#&gt; 0: car_initial3: arrives at the carwash</span></span>
<span id="cb3-15"><a href="#cb3-15"></a><span class="co">#&gt; 5: car0: arrives at the carwash</span></span>
<span id="cb3-16"><a href="#cb3-16"></a><span class="co">#&gt; 5: car_initial0: 86% of dirt was removed</span></span>
<span id="cb3-17"><a href="#cb3-17"></a><span class="co">#&gt; 5: car_initial1: 50% of dirt was removed</span></span>
<span id="cb3-18"><a href="#cb3-18"></a><span class="co">#&gt; 5: car_initial0: leaves the carwash</span></span>
<span id="cb3-19"><a href="#cb3-19"></a><span class="co">#&gt; 5: car_initial1: leaves the carwash</span></span>
<span id="cb3-20"><a href="#cb3-20"></a><span class="co">#&gt; 5: car_initial2: enters the carwash</span></span>
<span id="cb3-21"><a href="#cb3-21"></a><span class="co">#&gt; 5: car_initial3: enters the carwash</span></span>
<span id="cb3-22"><a href="#cb3-22"></a><span class="co">#&gt; 10: car_initial2: 59% of dirt was removed</span></span>
<span id="cb3-23"><a href="#cb3-23"></a><span class="co">#&gt; 10: car_initial3: 85% of dirt was removed</span></span>
<span id="cb3-24"><a href="#cb3-24"></a><span class="co">#&gt; 10: car_initial2: leaves the carwash</span></span>
<span id="cb3-25"><a href="#cb3-25"></a><span class="co">#&gt; 10: car_initial3: leaves the carwash</span></span>
<span id="cb3-26"><a href="#cb3-26"></a><span class="co">#&gt; 10: car1: arrives at the carwash</span></span>
<span id="cb3-27"><a href="#cb3-27"></a><span class="co">#&gt; 10: car1: enters the carwash</span></span>
<span id="cb3-28"><a href="#cb3-28"></a><span class="co">#&gt; 10: car0: enters the carwash</span></span>
<span id="cb3-29"><a href="#cb3-29"></a><span class="co">#&gt; 15: car1: 98% of dirt was removed</span></span>
<span id="cb3-30"><a href="#cb3-30"></a><span class="co">#&gt; 15: car0: 96% of dirt was removed</span></span>
<span id="cb3-31"><a href="#cb3-31"></a><span class="co">#&gt; 15: car1: leaves the carwash</span></span>
<span id="cb3-32"><a href="#cb3-32"></a><span class="co">#&gt; 15: car0: leaves the carwash</span></span>
<span id="cb3-33"><a href="#cb3-33"></a><span class="co">#&gt; 16: car2: arrives at the carwash</span></span>
<span id="cb3-34"><a href="#cb3-34"></a><span class="co">#&gt; 16: car2: enters the carwash</span></span>
<span id="cb3-35"><a href="#cb3-35"></a><span class="co">#&gt; simmer environment: anonymous | now: 20 | next: 21</span></span>
<span id="cb3-36"><a href="#cb3-36"></a><span class="co">#&gt; { Monitor: in memory }</span></span>
<span id="cb3-37"><a href="#cb3-37"></a><span class="co">#&gt; { Resource: wash | monitored: TRUE | server status: 1(2) | queue status: 0(Inf) }</span></span>
<span id="cb3-38"><a href="#cb3-38"></a><span class="co">#&gt; { Source: car_initial | monitored: 1 | n_generated: 4 }</span></span>
<span id="cb3-39"><a href="#cb3-39"></a><span class="co">#&gt; { Source: car | monitored: 1 | n_generated: 4 }</span></span></code></pre></div>
</div>
<div id="machine-shop" class="section level2">
<h2>Machine Shop</h2>
<p>Covers:</p>
<ul>
<li>Preemptive resources.</li>
<li>Interruptions.</li>
<li>Loops.</li>
<li>Attributes.</li>
</ul>
<p>From <a href="https://simpy.readthedocs.io/en/latest/examples/machine_shop.html">here</a>:</p>
<blockquote>
<p>This example comprises a workshop with <code>n</code> identical machines. A stream of jobs (enough to keep the machines busy) arrives. Each machine breaks down periodically. Repairs are carried out by one repairman. The repairman has other, less important tasks to perform, too. Broken machines preempt theses tasks. The repairman continues them when he is done with the machine repair. The workshop works continuously.</p>
</blockquote>
<p>First of all, we load the libraries and prepare the environment.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1"></a><span class="kw">library</span>(simmer)</span>
<span id="cb4-2"><a href="#cb4-2"></a></span>
<span id="cb4-3"><a href="#cb4-3"></a>PT_MEAN &lt;-<span class="st"> </span><span class="fl">10.0</span>         <span class="co"># Avg. processing time in minutes</span></span>
<span id="cb4-4"><a href="#cb4-4"></a>PT_SIGMA &lt;-<span class="st"> </span><span class="fl">2.0</span>         <span class="co"># Sigma of processing time</span></span>
<span id="cb4-5"><a href="#cb4-5"></a>MTTF &lt;-<span class="st"> </span><span class="fl">300.0</span>           <span class="co"># Mean time to failure in minutes</span></span>
<span id="cb4-6"><a href="#cb4-6"></a>BREAK_MEAN &lt;-<span class="st"> </span><span class="dv">1</span> <span class="op">/</span><span class="st"> </span>MTTF  <span class="co"># Param. for exponential distribution</span></span>
<span id="cb4-7"><a href="#cb4-7"></a>REPAIR_TIME &lt;-<span class="st"> </span><span class="fl">30.0</span>     <span class="co"># Time it takes to repair a machine in minutes</span></span>
<span id="cb4-8"><a href="#cb4-8"></a>JOB_DURATION &lt;-<span class="st"> </span><span class="fl">30.0</span>    <span class="co"># Duration of other jobs in minutes</span></span>
<span id="cb4-9"><a href="#cb4-9"></a>NUM_MACHINES &lt;-<span class="st"> </span><span class="dv">10</span>      <span class="co"># Number of machines in the machine shop</span></span>
<span id="cb4-10"><a href="#cb4-10"></a>WEEKS &lt;-<span class="st"> </span><span class="dv">4</span>              <span class="co"># Simulation time in weeks</span></span>
<span id="cb4-11"><a href="#cb4-11"></a>SIM_TIME &lt;-<span class="st"> </span>WEEKS <span class="op">*</span><span class="st"> </span><span class="dv">7</span> <span class="op">*</span><span class="st"> </span><span class="dv">24</span> <span class="op">*</span><span class="st"> </span><span class="dv">60</span>  <span class="co"># Simulation time in minutes</span></span>
<span id="cb4-12"><a href="#cb4-12"></a></span>
<span id="cb4-13"><a href="#cb4-13"></a><span class="co"># setup</span></span>
<span id="cb4-14"><a href="#cb4-14"></a><span class="kw">set.seed</span>(<span class="dv">42</span>)</span>
<span id="cb4-15"><a href="#cb4-15"></a>env &lt;-<span class="st"> </span><span class="kw">simmer</span>()</span></code></pre></div>
<p>The <code>make_parts</code> trajectory defines a machine’s operating loop. A worker seizes the machine and starts manufacturing and counting parts in an infinite loop. Provided we want more than one machine, we parametrise the trajectory as a function of the machine:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1"></a>make_parts &lt;-<span class="st"> </span><span class="cf">function</span>(machine)</span>
<span id="cb5-2"><a href="#cb5-2"></a>  <span class="kw">trajectory</span>() <span class="op">%&gt;%</span></span>
<span id="cb5-3"><a href="#cb5-3"></a><span class="st">    </span><span class="kw">seize</span>(machine, <span class="dv">1</span>) <span class="op">%&gt;%</span></span>
<span id="cb5-4"><a href="#cb5-4"></a><span class="st">    </span><span class="kw">timeout</span>(<span class="cf">function</span>() <span class="kw">rnorm</span>(<span class="dv">1</span>, PT_MEAN, PT_SIGMA)) <span class="op">%&gt;%</span></span>
<span id="cb5-5"><a href="#cb5-5"></a><span class="st">    </span><span class="kw">set_attribute</span>(<span class="st">&quot;parts&quot;</span>, <span class="dv">1</span>, <span class="dt">mod=</span><span class="st">&quot;+&quot;</span>) <span class="op">%&gt;%</span></span>
<span id="cb5-6"><a href="#cb5-6"></a><span class="st">    </span><span class="kw">rollback</span>(<span class="dv">2</span>, <span class="ot">Inf</span>) <span class="co"># go to &#39;timeout&#39; over and over</span></span></code></pre></div>
<p>Repairman’s <em>unimportant</em> jobs may be modelled in the same way (without the accounting part):</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1"></a>other_jobs &lt;-<span class="st"> </span><span class="kw">trajectory</span>() <span class="op">%&gt;%</span></span>
<span id="cb6-2"><a href="#cb6-2"></a><span class="st">  </span><span class="kw">seize</span>(<span class="st">&quot;repairman&quot;</span>, <span class="dv">1</span>) <span class="op">%&gt;%</span></span>
<span id="cb6-3"><a href="#cb6-3"></a><span class="st">  </span><span class="kw">timeout</span>(JOB_DURATION) <span class="op">%&gt;%</span></span>
<span id="cb6-4"><a href="#cb6-4"></a><span class="st">  </span><span class="kw">rollback</span>(<span class="dv">1</span>, <span class="ot">Inf</span>)</span></code></pre></div>
<p>Failures are high-priority arrivals, both for the machines and for the repairman. Each random generated failure will randomly select and seize (break) a machine, and will seize (call) the repairman. After the machine is repaired, both resources are released and the corresponding workers begin where they left.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1"></a>machines &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&quot;machine&quot;</span>, <span class="dv">1</span><span class="op">:</span>NUM_MACHINES<span class="dv">-1</span>)</span>
<span id="cb7-2"><a href="#cb7-2"></a></span>
<span id="cb7-3"><a href="#cb7-3"></a>failure &lt;-<span class="st"> </span><span class="kw">trajectory</span>() <span class="op">%&gt;%</span></span>
<span id="cb7-4"><a href="#cb7-4"></a><span class="st">  </span><span class="kw">select</span>(machines, <span class="dt">policy =</span> <span class="st">&quot;random&quot;</span>) <span class="op">%&gt;%</span></span>
<span id="cb7-5"><a href="#cb7-5"></a><span class="st">  </span><span class="kw">seize_selected</span>(<span class="dv">1</span>) <span class="op">%&gt;%</span></span>
<span id="cb7-6"><a href="#cb7-6"></a><span class="st">  </span><span class="kw">seize</span>(<span class="st">&quot;repairman&quot;</span>, <span class="dv">1</span>) <span class="op">%&gt;%</span></span>
<span id="cb7-7"><a href="#cb7-7"></a><span class="st">  </span><span class="kw">timeout</span>(REPAIR_TIME) <span class="op">%&gt;%</span></span>
<span id="cb7-8"><a href="#cb7-8"></a><span class="st">  </span><span class="kw">release</span>(<span class="st">&quot;repairman&quot;</span>, <span class="dv">1</span>) <span class="op">%&gt;%</span></span>
<span id="cb7-9"><a href="#cb7-9"></a><span class="st">  </span><span class="kw">release_selected</span>(<span class="dv">1</span>)</span></code></pre></div>
<p>The machines and their workers are appended to the simulation environment. Note that each machine, which is defined as preemptive, has space for one worker (or a failure) and no space in queue.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1"></a><span class="cf">for</span> (i <span class="cf">in</span> machines) env <span class="op">%&gt;%</span></span>
<span id="cb8-2"><a href="#cb8-2"></a><span class="st">  </span><span class="kw">add_resource</span>(i, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dt">preemptive =</span> <span class="ot">TRUE</span>) <span class="op">%&gt;%</span></span>
<span id="cb8-3"><a href="#cb8-3"></a><span class="st">  </span><span class="kw">add_generator</span>(<span class="kw">paste0</span>(i, <span class="st">&quot;_worker&quot;</span>), <span class="kw">make_parts</span>(i), <span class="kw">at</span>(<span class="dv">0</span>), <span class="dt">mon =</span> <span class="dv">2</span>)</span></code></pre></div>
<p>The same for the repairman, but this time the queue is infinite, since there could be any number of machines at any time waiting for repairments.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1"></a>env <span class="op">%&gt;%</span></span>
<span id="cb9-2"><a href="#cb9-2"></a><span class="st">  </span><span class="kw">add_resource</span>(<span class="st">&quot;repairman&quot;</span>, <span class="dv">1</span>, <span class="ot">Inf</span>, <span class="dt">preemptive =</span> <span class="ot">TRUE</span>) <span class="op">%&gt;%</span></span>
<span id="cb9-3"><a href="#cb9-3"></a><span class="st">  </span><span class="kw">add_generator</span>(<span class="st">&quot;repairman_worker&quot;</span>, other_jobs, <span class="kw">at</span>(<span class="dv">0</span>)) <span class="op">%&gt;%</span></span>
<span id="cb9-4"><a href="#cb9-4"></a><span class="st">  </span>invisible</span></code></pre></div>
<p>Finally, the failure generator is defined with <code>priority=1</code> (default: 0), and the simulation begins:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1"></a>env <span class="op">%&gt;%</span></span>
<span id="cb10-2"><a href="#cb10-2"></a><span class="st">  </span><span class="kw">add_generator</span>(<span class="st">&quot;failure&quot;</span>, failure, </span>
<span id="cb10-3"><a href="#cb10-3"></a>                <span class="cf">function</span>() <span class="kw">rexp</span>(<span class="dv">1</span>, BREAK_MEAN <span class="op">*</span><span class="st"> </span>NUM_MACHINES), </span>
<span id="cb10-4"><a href="#cb10-4"></a>                <span class="dt">priority =</span> <span class="dv">1</span>) <span class="op">%&gt;%</span></span>
<span id="cb10-5"><a href="#cb10-5"></a><span class="st">  </span><span class="kw">run</span>(SIM_TIME) <span class="op">%&gt;%</span><span class="st"> </span>invisible</span></code></pre></div>
<p>The last value per worker from the attributes table reports the number of parts made:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1"></a><span class="kw">aggregate</span>(value <span class="op">~</span><span class="st"> </span>name, <span class="kw">get_mon_attributes</span>(env), max)</span>
<span id="cb11-2"><a href="#cb11-2"></a><span class="co">#&gt;                name value</span></span>
<span id="cb11-3"><a href="#cb11-3"></a><span class="co">#&gt; 1  machine0_worker0  3250</span></span>
<span id="cb11-4"><a href="#cb11-4"></a><span class="co">#&gt; 2  machine1_worker0  3303</span></span>
<span id="cb11-5"><a href="#cb11-5"></a><span class="co">#&gt; 3  machine2_worker0  3241</span></span>
<span id="cb11-6"><a href="#cb11-6"></a><span class="co">#&gt; 4  machine3_worker0  3336</span></span>
<span id="cb11-7"><a href="#cb11-7"></a><span class="co">#&gt; 5  machine4_worker0  3399</span></span>
<span id="cb11-8"><a href="#cb11-8"></a><span class="co">#&gt; 6  machine5_worker0  3423</span></span>
<span id="cb11-9"><a href="#cb11-9"></a><span class="co">#&gt; 7  machine6_worker0  3304</span></span>
<span id="cb11-10"><a href="#cb11-10"></a><span class="co">#&gt; 8  machine7_worker0  3181</span></span>
<span id="cb11-11"><a href="#cb11-11"></a><span class="co">#&gt; 9  machine8_worker0  3253</span></span>
<span id="cb11-12"><a href="#cb11-12"></a><span class="co">#&gt; 10 machine9_worker0  3169</span></span></code></pre></div>
</div>
<div id="movie-renege" class="section level2">
<h2>Movie Renege</h2>
<p>Covers:</p>
<ul>
<li>Standard resources.</li>
<li>Condition events.</li>
<li>Shared events.</li>
<li>Attributes.</li>
</ul>
<p>From <a href="https://simpy.readthedocs.io/en/latest/examples/movie_renege.html">here</a>:</p>
<blockquote>
<p>This example models a movie theater with one ticket counter selling tickets for three movies (next show only). People arrive at random times and try to buy a random number (1-6) of tickets for a random movie. When a movie is sold out, all people waiting to buy a ticket for that movie renege (leave the queue).</p>
</blockquote>
<p>First of all, we load the libraries and prepare the environment.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1"></a><span class="kw">library</span>(simmer)</span>
<span id="cb12-2"><a href="#cb12-2"></a></span>
<span id="cb12-3"><a href="#cb12-3"></a>TICKETS &lt;-<span class="st"> </span><span class="dv">50</span>     <span class="co"># Number of tickets per movie</span></span>
<span id="cb12-4"><a href="#cb12-4"></a>SIM_TIME &lt;-<span class="st"> </span><span class="dv">120</span>   <span class="co"># Simulate until</span></span>
<span id="cb12-5"><a href="#cb12-5"></a>movies &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;R Unchained&quot;</span>, <span class="st">&quot;Kill Process&quot;</span>, <span class="st">&quot;Pulp Implementation&quot;</span>)</span>
<span id="cb12-6"><a href="#cb12-6"></a></span>
<span id="cb12-7"><a href="#cb12-7"></a><span class="co"># setup</span></span>
<span id="cb12-8"><a href="#cb12-8"></a><span class="kw">set.seed</span>(<span class="dv">42</span>)</span>
<span id="cb12-9"><a href="#cb12-9"></a>env &lt;-<span class="st"> </span><span class="kw">simmer</span>()</span></code></pre></div>
<p>The main actor of this simulation is the <em>moviegoer</em>, a process that will try to buy a number of tickets for a certain movie. The logic is as follows:</p>
<ol style="list-style-type: decimal">
<li><strong>Select</strong> a movie and go to the theater.</li>
<li>At any moment, the <em>moviegoer</em> <strong>reneges if</strong> the movie becomes sold out (the “sold out” event is received).</li>
<li>In particular, <strong>leave</strong> immediately if the movie already became sold out.</li>
<li>Reach the ticket counter and stay in the queue. When the turn comes (counter is <strong>seized</strong>),
<ol style="list-style-type: decimal">
<li>Try to buy (<strong>seize</strong> the resource) tickets (randomly chosen between 1 and 6).
<ul>
<li>If there are not enough tickets, the <em>moviegoer</em> is <strong>rejected</strong> after some discussion.</li>
</ul></li>
<li>Provided the <em>moviegoer</em> has tickets, the reneging condition is <strong>aborted</strong>.</li>
<li>Check the tickets available and, if at most one ticket is left…
<ul>
<li><strong>Set</strong> instant rejection for future customers (at point 3.).</li>
<li><strong>Send</strong> the “sold out” event (subscribed at point 2.) for current customers (waiting at point 4.).</li>
</ul></li>
</ol></li>
<li><strong>Release</strong> the ticket counter after the duration of the purchase.</li>
<li>Enjoy the movie!</li>
</ol>
<p>This recipe is directly translated into a <code>simmer</code> trajectory as follows:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1"></a>get_movie &lt;-<span class="st"> </span><span class="cf">function</span>() movies[<span class="kw">get_attribute</span>(env, <span class="st">&quot;movie&quot;</span>)]</span>
<span id="cb13-2"><a href="#cb13-2"></a>soldout_signal &lt;-<span class="st"> </span><span class="cf">function</span>() <span class="kw">paste0</span>(<span class="kw">get_movie</span>(), <span class="st">&quot; sold out&quot;</span>)</span>
<span id="cb13-3"><a href="#cb13-3"></a>check_soldout &lt;-<span class="st"> </span><span class="cf">function</span>() <span class="kw">get_capacity</span>(env, <span class="kw">get_movie</span>()) <span class="op">==</span><span class="st"> </span><span class="dv">0</span></span>
<span id="cb13-4"><a href="#cb13-4"></a>check_tickets_available &lt;-<span class="st"> </span><span class="cf">function</span>()</span>
<span id="cb13-5"><a href="#cb13-5"></a>  <span class="kw">get_server_count</span>(env, <span class="kw">get_movie</span>()) <span class="op">&gt;</span><span class="st"> </span>(TICKETS <span class="op">-</span><span class="st"> </span><span class="dv">2</span>)</span>
<span id="cb13-6"><a href="#cb13-6"></a></span>
<span id="cb13-7"><a href="#cb13-7"></a>moviegoer &lt;-<span class="st"> </span><span class="kw">trajectory</span>() <span class="op">%&gt;%</span></span>
<span id="cb13-8"><a href="#cb13-8"></a><span class="st">  </span><span class="co"># select a movie</span></span>
<span id="cb13-9"><a href="#cb13-9"></a><span class="st">  </span><span class="kw">set_attribute</span>(<span class="st">&quot;movie&quot;</span>, <span class="cf">function</span>() <span class="kw">sample</span>(<span class="dv">3</span>, <span class="dv">1</span>)) <span class="op">%&gt;%</span></span>
<span id="cb13-10"><a href="#cb13-10"></a><span class="st">  </span><span class="kw">select</span>(get_movie) <span class="op">%&gt;%</span></span>
<span id="cb13-11"><a href="#cb13-11"></a><span class="st">  </span><span class="co"># set reneging condition</span></span>
<span id="cb13-12"><a href="#cb13-12"></a><span class="st">  </span><span class="kw">renege_if</span>(soldout_signal) <span class="op">%&gt;%</span></span>
<span id="cb13-13"><a href="#cb13-13"></a><span class="st">  </span><span class="co"># leave immediately if the movie was already sold out</span></span>
<span id="cb13-14"><a href="#cb13-14"></a><span class="st">  </span><span class="kw">leave</span>(check_soldout) <span class="op">%&gt;%</span></span>
<span id="cb13-15"><a href="#cb13-15"></a><span class="st">  </span><span class="co"># wait for my turn</span></span>
<span id="cb13-16"><a href="#cb13-16"></a><span class="st">  </span><span class="kw">seize</span>(<span class="st">&quot;counter&quot;</span>, <span class="dv">1</span>) <span class="op">%&gt;%</span></span>
<span id="cb13-17"><a href="#cb13-17"></a><span class="st">  </span><span class="co"># buy tickets</span></span>
<span id="cb13-18"><a href="#cb13-18"></a><span class="st">  </span><span class="kw">seize_selected</span>(</span>
<span id="cb13-19"><a href="#cb13-19"></a>    <span class="cf">function</span>() <span class="kw">sample</span>(<span class="dv">6</span>, <span class="dv">1</span>), <span class="dt">continue =</span> <span class="ot">FALSE</span>,</span>
<span id="cb13-20"><a href="#cb13-20"></a>    <span class="dt">reject =</span> <span class="kw">trajectory</span>() <span class="op">%&gt;%</span></span>
<span id="cb13-21"><a href="#cb13-21"></a><span class="st">      </span><span class="kw">timeout</span>(<span class="fl">0.5</span>) <span class="op">%&gt;%</span></span>
<span id="cb13-22"><a href="#cb13-22"></a><span class="st">      </span><span class="kw">release</span>(<span class="st">&quot;counter&quot;</span>, <span class="dv">1</span>)</span>
<span id="cb13-23"><a href="#cb13-23"></a>  ) <span class="op">%&gt;%</span></span>
<span id="cb13-24"><a href="#cb13-24"></a><span class="st">  </span><span class="co"># abort reneging condition</span></span>
<span id="cb13-25"><a href="#cb13-25"></a><span class="st">  </span><span class="kw">renege_abort</span>() <span class="op">%&gt;%</span></span>
<span id="cb13-26"><a href="#cb13-26"></a><span class="st">  </span><span class="co"># check the tickets available</span></span>
<span id="cb13-27"><a href="#cb13-27"></a><span class="st">  </span><span class="kw">branch</span>(</span>
<span id="cb13-28"><a href="#cb13-28"></a>    check_tickets_available, <span class="dt">continue =</span> <span class="ot">TRUE</span>,</span>
<span id="cb13-29"><a href="#cb13-29"></a>    <span class="kw">trajectory</span>() <span class="op">%&gt;%</span></span>
<span id="cb13-30"><a href="#cb13-30"></a><span class="st">      </span><span class="kw">set_capacity_selected</span>(<span class="dv">0</span>) <span class="op">%&gt;%</span></span>
<span id="cb13-31"><a href="#cb13-31"></a><span class="st">      </span><span class="kw">send</span>(soldout_signal)</span>
<span id="cb13-32"><a href="#cb13-32"></a>  ) <span class="op">%&gt;%</span></span>
<span id="cb13-33"><a href="#cb13-33"></a><span class="st">  </span><span class="kw">timeout</span>(<span class="dv">1</span>) <span class="op">%&gt;%</span></span>
<span id="cb13-34"><a href="#cb13-34"></a><span class="st">  </span><span class="kw">release</span>(<span class="st">&quot;counter&quot;</span>, <span class="dv">1</span>) <span class="op">%&gt;%</span></span>
<span id="cb13-35"><a href="#cb13-35"></a><span class="st">  </span><span class="co"># watch the movie</span></span>
<span id="cb13-36"><a href="#cb13-36"></a><span class="st">  </span><span class="kw">wait</span>()</span></code></pre></div>
<p>which actually constitutes a quite interesting subset of <code>simmer</code>’s capabilities. The next step is to add the required resources to the environment <code>env</code>: the three movies and the ticket counter.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1"></a><span class="co"># add movies as resources with capacity TICKETS and no queue</span></span>
<span id="cb14-2"><a href="#cb14-2"></a><span class="cf">for</span> (i <span class="cf">in</span> movies) env <span class="op">%&gt;%</span></span>
<span id="cb14-3"><a href="#cb14-3"></a><span class="st">  </span><span class="kw">add_resource</span>(i, TICKETS, <span class="dv">0</span>)</span>
<span id="cb14-4"><a href="#cb14-4"></a></span>
<span id="cb14-5"><a href="#cb14-5"></a><span class="co"># add ticket counter with capacity 1 and infinite queue</span></span>
<span id="cb14-6"><a href="#cb14-6"></a>env <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">add_resource</span>(<span class="st">&quot;counter&quot;</span>, <span class="dv">1</span>, <span class="ot">Inf</span>)</span>
<span id="cb14-7"><a href="#cb14-7"></a><span class="co">#&gt; simmer environment: anonymous | now: 0 | next: </span></span>
<span id="cb14-8"><a href="#cb14-8"></a><span class="co">#&gt; { Monitor: in memory }</span></span>
<span id="cb14-9"><a href="#cb14-9"></a><span class="co">#&gt; { Resource: R Unchained | monitored: TRUE | server status: 0(50) | queue status: 0(0) }</span></span>
<span id="cb14-10"><a href="#cb14-10"></a><span class="co">#&gt; { Resource: Kill Process | monitored: TRUE | server status: 0(50) | queue status: 0(0) }</span></span>
<span id="cb14-11"><a href="#cb14-11"></a><span class="co">#&gt; { Resource: Pulp Implementation | monitored: TRUE | server status: 0(50) | queue status: 0(0) }</span></span>
<span id="cb14-12"><a href="#cb14-12"></a><span class="co">#&gt; { Resource: counter | monitored: TRUE | server status: 0(1) | queue status: 0(Inf) }</span></span></code></pre></div>
<p>And finally, we attach an exponential <em>moviegoer</em> generator to the <code>moviegoer</code> trajectory and the simulation starts:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1"></a><span class="co"># add a moviegoer generator and start simulation</span></span>
<span id="cb15-2"><a href="#cb15-2"></a>env <span class="op">%&gt;%</span></span>
<span id="cb15-3"><a href="#cb15-3"></a><span class="st">  </span><span class="kw">add_generator</span>(<span class="st">&quot;moviegoer&quot;</span>, moviegoer, <span class="cf">function</span>() <span class="kw">rexp</span>(<span class="dv">1</span>, <span class="dv">1</span> <span class="op">/</span><span class="st"> </span><span class="fl">0.5</span>), <span class="dt">mon=</span><span class="dv">2</span>) <span class="op">%&gt;%</span></span>
<span id="cb15-4"><a href="#cb15-4"></a><span class="st">  </span><span class="kw">run</span>(SIM_TIME)</span>
<span id="cb15-5"><a href="#cb15-5"></a><span class="co">#&gt; simmer environment: anonymous | now: 120 | next: 120.027892152333</span></span>
<span id="cb15-6"><a href="#cb15-6"></a><span class="co">#&gt; { Monitor: in memory }</span></span>
<span id="cb15-7"><a href="#cb15-7"></a><span class="co">#&gt; { Resource: R Unchained | monitored: TRUE | server status: 50(0) | queue status: 0(0) }</span></span>
<span id="cb15-8"><a href="#cb15-8"></a><span class="co">#&gt; { Resource: Kill Process | monitored: TRUE | server status: 50(0) | queue status: 0(0) }</span></span>
<span id="cb15-9"><a href="#cb15-9"></a><span class="co">#&gt; { Resource: Pulp Implementation | monitored: TRUE | server status: 49(0) | queue status: 0(0) }</span></span>
<span id="cb15-10"><a href="#cb15-10"></a><span class="co">#&gt; { Resource: counter | monitored: TRUE | server status: 0(1) | queue status: 0(Inf) }</span></span>
<span id="cb15-11"><a href="#cb15-11"></a><span class="co">#&gt; { Source: moviegoer | monitored: 2 | n_generated: 223 }</span></span></code></pre></div>
<p>The analysis is performed with standard R tools:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1"></a><span class="co"># get the three rows with the sold out instants</span></span>
<span id="cb16-2"><a href="#cb16-2"></a>sold_time &lt;-<span class="st"> </span><span class="kw">get_mon_resources</span>(env) <span class="op">%&gt;%</span></span>
<span id="cb16-3"><a href="#cb16-3"></a><span class="st">  </span><span class="kw">subset</span>(resource <span class="op">!=</span><span class="st"> &quot;counter&quot;</span> <span class="op">&amp;</span><span class="st"> </span>capacity <span class="op">==</span><span class="st"> </span><span class="dv">0</span>)</span>
<span id="cb16-4"><a href="#cb16-4"></a></span>
<span id="cb16-5"><a href="#cb16-5"></a><span class="co"># get the arrivals that left at the sold out instants</span></span>
<span id="cb16-6"><a href="#cb16-6"></a><span class="co"># count the number of arrivals per movie</span></span>
<span id="cb16-7"><a href="#cb16-7"></a>n_reneges &lt;-<span class="st"> </span><span class="kw">get_mon_arrivals</span>(env) <span class="op">%&gt;%</span></span>
<span id="cb16-8"><a href="#cb16-8"></a><span class="st">  </span><span class="kw">subset</span>(finished <span class="op">==</span><span class="st"> </span><span class="ot">FALSE</span> <span class="op">&amp;</span><span class="st"> </span>end_time <span class="op">%in%</span><span class="st"> </span>sold_time<span class="op">$</span>time) <span class="op">%&gt;%</span></span>
<span id="cb16-9"><a href="#cb16-9"></a><span class="st">  </span><span class="kw">merge</span>(<span class="kw">get_mon_attributes</span>(env)) <span class="op">%&gt;%</span></span>
<span id="cb16-10"><a href="#cb16-10"></a><span class="st">  </span><span class="kw">transform</span>(<span class="dt">resource =</span> movies[value]) <span class="op">%&gt;%</span></span>
<span id="cb16-11"><a href="#cb16-11"></a><span class="st">  </span><span class="kw">aggregate</span>(value <span class="op">~</span><span class="st"> </span>resource, <span class="dt">data=</span>., length)</span>
<span id="cb16-12"><a href="#cb16-12"></a></span>
<span id="cb16-13"><a href="#cb16-13"></a><span class="co"># merge the info  and print</span></span>
<span id="cb16-14"><a href="#cb16-14"></a><span class="kw">invisible</span>(<span class="kw">apply</span>(<span class="kw">merge</span>(sold_time, n_reneges), <span class="dv">1</span>, <span class="cf">function</span>(i) {</span>
<span id="cb16-15"><a href="#cb16-15"></a>  <span class="kw">cat</span>(<span class="st">&quot;Movie &#39;&quot;</span>, i[<span class="st">&quot;resource&quot;</span>], <span class="st">&quot;&#39; was sold out in &quot;</span>, i[<span class="st">&quot;time&quot;</span>], <span class="st">&quot; minutes.</span><span class="ch">\n</span><span class="st">&quot;</span>, </span>
<span id="cb16-16"><a href="#cb16-16"></a>      <span class="st">&quot;  Number of people that left the queue: &quot;</span>, i[<span class="st">&quot;value&quot;</span>], <span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span>, <span class="dt">sep=</span><span class="st">&quot;&quot;</span>)</span>
<span id="cb16-17"><a href="#cb16-17"></a>}))</span>
<span id="cb16-18"><a href="#cb16-18"></a><span class="co">#&gt; Movie &#39;Kill Process&#39; was sold out in 53.09917 minutes.</span></span>
<span id="cb16-19"><a href="#cb16-19"></a><span class="co">#&gt;   Number of people that left the queue: 9</span></span>
<span id="cb16-20"><a href="#cb16-20"></a><span class="co">#&gt; Movie &#39;Pulp Implementation&#39; was sold out in 51.59917 minutes.</span></span>
<span id="cb16-21"><a href="#cb16-21"></a><span class="co">#&gt;   Number of people that left the queue: 9</span></span>
<span id="cb16-22"><a href="#cb16-22"></a><span class="co">#&gt; Movie &#39;R Unchained&#39; was sold out in 33.09917 minutes.</span></span>
<span id="cb16-23"><a href="#cb16-23"></a><span class="co">#&gt;   Number of people that left the queue: 8</span></span></code></pre></div>
</div>
<div id="gas-station-refuelling" class="section level2">
<h2>Gas Station Refuelling</h2>
<p>Covers:</p>
<ul>
<li>Standard resources.</li>
<li>Waiting for other processes.</li>
<li>Condition events.</li>
<li>Shared events.</li>
<li>Concatenating trajectories.</li>
<li>Loops.</li>
<li>Logging messages into the console.</li>
</ul>
<p>From <a href="https://simpy.readthedocs.io/en/latest/examples/gas_station_refuel.html">here</a>:</p>
<blockquote>
<p>This example models a gas station and cars that arrive for refuelling. The gas station has a limited number of fuel pumps and a fuel tank that is shared between the fuel pumps.</p>
<p>Vehicles arriving at the gas station first request a fuel pump from the station. Once they acquire one, they try to take the desired amount of fuel from the fuel pump. They leave when they are done.</p>
<p>The fuel level is reqularly monitored by a controller. When the level drops below a certain threshold, a tank truck is called for refilling the tank.</p>
</blockquote>
<p>Parameters and setup:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1"></a><span class="kw">library</span>(simmer)</span>
<span id="cb17-2"><a href="#cb17-2"></a></span>
<span id="cb17-3"><a href="#cb17-3"></a>GAS_STATION_SIZE &lt;-<span class="st"> </span><span class="dv">200</span>     <span class="co"># liters</span></span>
<span id="cb17-4"><a href="#cb17-4"></a>THRESHOLD &lt;-<span class="st"> </span><span class="dv">10</span>             <span class="co"># Threshold for calling the tank truck (in %)</span></span>
<span id="cb17-5"><a href="#cb17-5"></a>FUEL_TANK_SIZE &lt;-<span class="st"> </span><span class="dv">50</span>        <span class="co"># liters</span></span>
<span id="cb17-6"><a href="#cb17-6"></a>FUEL_TANK_LEVEL &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">5</span>, <span class="dv">25</span>) <span class="co"># Min/max levels of fuel tanks (in liters)</span></span>
<span id="cb17-7"><a href="#cb17-7"></a>REFUELING_SPEED &lt;-<span class="st"> </span><span class="dv">2</span>        <span class="co"># liters / second</span></span>
<span id="cb17-8"><a href="#cb17-8"></a>TANK_TRUCK_TIME &lt;-<span class="st"> </span><span class="dv">300</span>      <span class="co"># Seconds it takes the tank truck to arrive</span></span>
<span id="cb17-9"><a href="#cb17-9"></a>T_INTER &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">30</span>, <span class="dv">100</span>)       <span class="co"># Create a car every [min, max] seconds</span></span>
<span id="cb17-10"><a href="#cb17-10"></a>SIM_TIME &lt;-<span class="st"> </span><span class="dv">1000</span>            <span class="co"># Simulation time in seconds</span></span>
<span id="cb17-11"><a href="#cb17-11"></a></span>
<span id="cb17-12"><a href="#cb17-12"></a><span class="co"># setup</span></span>
<span id="cb17-13"><a href="#cb17-13"></a><span class="kw">set.seed</span>(<span class="dv">42</span>)</span>
<span id="cb17-14"><a href="#cb17-14"></a>env &lt;-<span class="st"> </span><span class="kw">simmer</span>()</span></code></pre></div>
<p>SimPy solves this problem using a special kind of resource called <em>container</em>, which is not present in <code>simmer</code> so far. However, a container is nothing more than an embellished counter. Therefore, we can implement this in <code>simmer</code> with a global counter (<code>GAS_STATION_LEVEL</code> here), some signaling and some care checking the counter bounds.</p>
<p>Let us consider just the refuelling process in the first place. A car needs to check whether there is enough fuel available to fill its tank. If not, it needs to block until the gas station is refilled.</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1"></a>GAS_STATION_LEVEL &lt;-<span class="st"> </span>GAS_STATION_SIZE</span>
<span id="cb18-2"><a href="#cb18-2"></a>signal &lt;-<span class="st"> &quot;gas station refilled&quot;</span></span>
<span id="cb18-3"><a href="#cb18-3"></a></span>
<span id="cb18-4"><a href="#cb18-4"></a>refuelling &lt;-<span class="st"> </span><span class="kw">trajectory</span>() <span class="op">%&gt;%</span></span>
<span id="cb18-5"><a href="#cb18-5"></a><span class="st">  </span><span class="co"># check if there is enough fuel available</span></span>
<span id="cb18-6"><a href="#cb18-6"></a><span class="st">  </span><span class="kw">branch</span>(<span class="cf">function</span>() FUEL_TANK_SIZE <span class="op">-</span><span class="st"> </span><span class="kw">get_attribute</span>(env, <span class="st">&quot;level&quot;</span>) <span class="op">&gt;</span><span class="st"> </span>GAS_STATION_LEVEL, </span>
<span id="cb18-7"><a href="#cb18-7"></a>         <span class="dt">continue =</span> <span class="ot">TRUE</span>,</span>
<span id="cb18-8"><a href="#cb18-8"></a>         <span class="co"># if not, block until the signal &quot;gas station refilled&quot; is received</span></span>
<span id="cb18-9"><a href="#cb18-9"></a>         <span class="kw">trajectory</span>() <span class="op">%&gt;%</span></span>
<span id="cb18-10"><a href="#cb18-10"></a><span class="st">           </span><span class="kw">trap</span>(signal) <span class="op">%&gt;%</span></span>
<span id="cb18-11"><a href="#cb18-11"></a><span class="st">           </span><span class="kw">wait</span>() <span class="op">%&gt;%</span></span>
<span id="cb18-12"><a href="#cb18-12"></a><span class="st">           </span><span class="kw">untrap</span>(signal)</span>
<span id="cb18-13"><a href="#cb18-13"></a>  ) <span class="op">%&gt;%</span></span>
<span id="cb18-14"><a href="#cb18-14"></a><span class="st">  </span><span class="co"># refuel</span></span>
<span id="cb18-15"><a href="#cb18-15"></a><span class="st">  </span><span class="kw">timeout</span>(<span class="cf">function</span>() {</span>
<span id="cb18-16"><a href="#cb18-16"></a>    liters_required &lt;-<span class="st"> </span>FUEL_TANK_SIZE <span class="op">-</span><span class="st"> </span><span class="kw">get_attribute</span>(env, <span class="st">&quot;level&quot;</span>)</span>
<span id="cb18-17"><a href="#cb18-17"></a>    GAS_STATION_LEVEL &lt;&lt;-<span class="st"> </span>GAS_STATION_LEVEL <span class="op">-</span><span class="st"> </span>liters_required</span>
<span id="cb18-18"><a href="#cb18-18"></a>    <span class="kw">return</span>(liters_required <span class="op">/</span><span class="st"> </span>REFUELING_SPEED)</span>
<span id="cb18-19"><a href="#cb18-19"></a>  })</span></code></pre></div>
<p>Now a car’s trajectory is straightforward. First, the starting time is saved as well as the tank level. Then, the car seizes a pump, refuels and leaves.</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1"></a>car &lt;-<span class="st"> </span><span class="kw">trajectory</span>() <span class="op">%&gt;%</span></span>
<span id="cb19-2"><a href="#cb19-2"></a><span class="st">  </span><span class="kw">set_attribute</span>(<span class="kw">c</span>(<span class="st">&quot;start&quot;</span>, <span class="st">&quot;level&quot;</span>), <span class="cf">function</span>() </span>
<span id="cb19-3"><a href="#cb19-3"></a>    <span class="kw">c</span>(<span class="kw">now</span>(env), <span class="kw">sample</span>(FUEL_TANK_LEVEL[<span class="dv">1</span>]<span class="op">:</span>FUEL_TANK_LEVEL[<span class="dv">2</span>], <span class="dv">1</span>))) <span class="op">%&gt;%</span></span>
<span id="cb19-4"><a href="#cb19-4"></a><span class="st">  </span><span class="kw">log_</span>(<span class="st">&quot;arriving at gas station&quot;</span>) <span class="op">%&gt;%</span></span>
<span id="cb19-5"><a href="#cb19-5"></a><span class="st">  </span><span class="kw">seize</span>(<span class="st">&quot;pump&quot;</span>, <span class="dv">1</span>) <span class="op">%&gt;%</span></span>
<span id="cb19-6"><a href="#cb19-6"></a><span class="st">  </span><span class="co"># &#39;join()&#39; concatenates the refuelling trajectory here</span></span>
<span id="cb19-7"><a href="#cb19-7"></a><span class="st">  </span><span class="kw">join</span>(refuelling) <span class="op">%&gt;%</span></span>
<span id="cb19-8"><a href="#cb19-8"></a><span class="st">  </span><span class="kw">release</span>(<span class="st">&quot;pump&quot;</span>, <span class="dv">1</span>) <span class="op">%&gt;%</span></span>
<span id="cb19-9"><a href="#cb19-9"></a><span class="st">  </span><span class="kw">log_</span>(<span class="cf">function</span>() </span>
<span id="cb19-10"><a href="#cb19-10"></a>    <span class="kw">paste0</span>(<span class="st">&quot;finished refuelling in &quot;</span>, <span class="kw">now</span>(env) <span class="op">-</span><span class="st"> </span><span class="kw">get_attribute</span>(env, <span class="st">&quot;start&quot;</span>), <span class="st">&quot; seconds&quot;</span>))</span></code></pre></div>
<p>The tank truck takes some time to arrive. Then, the gas station is completely refilled and the signal “gas station refilled” is sent to the blocked cars.</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1"></a>tank_truck &lt;-<span class="st"> </span><span class="kw">trajectory</span>() <span class="op">%&gt;%</span></span>
<span id="cb20-2"><a href="#cb20-2"></a><span class="st">  </span><span class="kw">timeout</span>(TANK_TRUCK_TIME) <span class="op">%&gt;%</span></span>
<span id="cb20-3"><a href="#cb20-3"></a><span class="st">  </span><span class="kw">log_</span>(<span class="st">&quot;tank truck arriving at gas station&quot;</span>) <span class="op">%&gt;%</span></span>
<span id="cb20-4"><a href="#cb20-4"></a><span class="st">  </span><span class="kw">log_</span>(<span class="cf">function</span>() {</span>
<span id="cb20-5"><a href="#cb20-5"></a>    refill &lt;-<span class="st"> </span>GAS_STATION_SIZE <span class="op">-</span><span class="st"> </span>GAS_STATION_LEVEL</span>
<span id="cb20-6"><a href="#cb20-6"></a>    GAS_STATION_LEVEL &lt;&lt;-<span class="st"> </span>GAS_STATION_SIZE</span>
<span id="cb20-7"><a href="#cb20-7"></a>    <span class="kw">paste0</span>(<span class="st">&quot;tank truck refilling &quot;</span>, refill, <span class="st">&quot; liters&quot;</span>)</span>
<span id="cb20-8"><a href="#cb20-8"></a>  }) <span class="op">%&gt;%</span></span>
<span id="cb20-9"><a href="#cb20-9"></a><span class="st">  </span><span class="kw">send</span>(signal)</span></code></pre></div>
<p>The controller periodically checks the <code>GAS_STATION_LEVEL</code> and calls the tank truck when needed.</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1"></a>controller &lt;-<span class="st"> </span><span class="kw">trajectory</span>() <span class="op">%&gt;%</span></span>
<span id="cb21-2"><a href="#cb21-2"></a><span class="st">  </span><span class="kw">branch</span>(<span class="cf">function</span>() GAS_STATION_LEVEL <span class="op">/</span><span class="st"> </span>GAS_STATION_SIZE <span class="op">*</span><span class="st"> </span><span class="dv">100</span> <span class="op">&lt;</span><span class="st"> </span>THRESHOLD, </span>
<span id="cb21-3"><a href="#cb21-3"></a>         <span class="dt">continue =</span> <span class="ot">TRUE</span>,</span>
<span id="cb21-4"><a href="#cb21-4"></a>         <span class="kw">trajectory</span>() <span class="op">%&gt;%</span></span>
<span id="cb21-5"><a href="#cb21-5"></a><span class="st">           </span><span class="kw">log_</span>(<span class="st">&quot;calling the tank truck&quot;</span>) <span class="op">%&gt;%</span></span>
<span id="cb21-6"><a href="#cb21-6"></a><span class="st">           </span><span class="kw">join</span>(tank_truck)</span>
<span id="cb21-7"><a href="#cb21-7"></a>  ) <span class="op">%&gt;%</span></span>
<span id="cb21-8"><a href="#cb21-8"></a><span class="st">  </span><span class="kw">timeout</span>(<span class="dv">10</span>) <span class="op">%&gt;%</span></span>
<span id="cb21-9"><a href="#cb21-9"></a><span class="st">  </span><span class="kw">rollback</span>(<span class="dv">2</span>, <span class="ot">Inf</span>)</span></code></pre></div>
<p>Finally, we need to add a couple of pumps, a controller worker and a car generator.</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1"></a>env <span class="op">%&gt;%</span></span>
<span id="cb22-2"><a href="#cb22-2"></a><span class="st">  </span><span class="kw">add_resource</span>(<span class="st">&quot;pump&quot;</span>, <span class="dv">2</span>) <span class="op">%&gt;%</span></span>
<span id="cb22-3"><a href="#cb22-3"></a><span class="st">  </span><span class="kw">add_generator</span>(<span class="st">&quot;controller&quot;</span>, controller, <span class="kw">at</span>(<span class="dv">0</span>)) <span class="op">%&gt;%</span></span>
<span id="cb22-4"><a href="#cb22-4"></a><span class="st">  </span><span class="kw">add_generator</span>(<span class="st">&quot;car&quot;</span>, car, <span class="cf">function</span>() <span class="kw">sample</span>(T_INTER[<span class="dv">1</span>]<span class="op">:</span>T_INTER[<span class="dv">2</span>], <span class="dv">1</span>)) <span class="op">%&gt;%</span></span>
<span id="cb22-5"><a href="#cb22-5"></a><span class="st">  </span><span class="kw">run</span>(SIM_TIME)</span>
<span id="cb22-6"><a href="#cb22-6"></a><span class="co">#&gt; 78: car0: arriving at gas station</span></span>
<span id="cb22-7"><a href="#cb22-7"></a><span class="co">#&gt; 98.5: car0: finished refuelling in 20.5 seconds</span></span>
<span id="cb22-8"><a href="#cb22-8"></a><span class="co">#&gt; 172: car1: arriving at gas station</span></span>
<span id="cb22-9"><a href="#cb22-9"></a><span class="co">#&gt; 190: car1: finished refuelling in 18 seconds</span></span>
<span id="cb22-10"><a href="#cb22-10"></a><span class="co">#&gt; 219: car2: arriving at gas station</span></span>
<span id="cb22-11"><a href="#cb22-11"></a><span class="co">#&gt; 233.5: car2: finished refuelling in 14.5 seconds</span></span>
<span id="cb22-12"><a href="#cb22-12"></a><span class="co">#&gt; 295: car3: arriving at gas station</span></span>
<span id="cb22-13"><a href="#cb22-13"></a><span class="co">#&gt; 314.5: car3: finished refuelling in 19.5 seconds</span></span>
<span id="cb22-14"><a href="#cb22-14"></a><span class="co">#&gt; 361: car4: arriving at gas station</span></span>
<span id="cb22-15"><a href="#cb22-15"></a><span class="co">#&gt; 377: car4: finished refuelling in 16 seconds</span></span>
<span id="cb22-16"><a href="#cb22-16"></a><span class="co">#&gt; 410: car5: arriving at gas station</span></span>
<span id="cb22-17"><a href="#cb22-17"></a><span class="co">#&gt; 442: car6: arriving at gas station</span></span>
<span id="cb22-18"><a href="#cb22-18"></a><span class="co">#&gt; 498: car7: arriving at gas station</span></span>
<span id="cb22-19"><a href="#cb22-19"></a><span class="co">#&gt; 532: car8: arriving at gas station</span></span>
<span id="cb22-20"><a href="#cb22-20"></a><span class="co">#&gt; 595: car9: arriving at gas station</span></span>
<span id="cb22-21"><a href="#cb22-21"></a><span class="co">#&gt; 627: car10: arriving at gas station</span></span>
<span id="cb22-22"><a href="#cb22-22"></a><span class="co">#&gt; 698: car11: arriving at gas station</span></span>
<span id="cb22-23"><a href="#cb22-23"></a><span class="co">#&gt; 742: car12: arriving at gas station</span></span>
<span id="cb22-24"><a href="#cb22-24"></a><span class="co">#&gt; 807: car13: arriving at gas station</span></span>
<span id="cb22-25"><a href="#cb22-25"></a><span class="co">#&gt; 854: car14: arriving at gas station</span></span>
<span id="cb22-26"><a href="#cb22-26"></a><span class="co">#&gt; 952: car15: arriving at gas station</span></span>
<span id="cb22-27"><a href="#cb22-27"></a><span class="co">#&gt; simmer environment: anonymous | now: 1000 | next: 1000</span></span>
<span id="cb22-28"><a href="#cb22-28"></a><span class="co">#&gt; { Monitor: in memory }</span></span>
<span id="cb22-29"><a href="#cb22-29"></a><span class="co">#&gt; { Resource: pump | monitored: TRUE | server status: 2(2) | queue status: 9(Inf) }</span></span>
<span id="cb22-30"><a href="#cb22-30"></a><span class="co">#&gt; { Source: controller | monitored: 1 | n_generated: 1 }</span></span>
<span id="cb22-31"><a href="#cb22-31"></a><span class="co">#&gt; { Source: car | monitored: 1 | n_generated: 17 }</span></span></code></pre></div>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
